/*
 * Структурные заголовки и правила их отображения.
 *
 * Этот модуль определяет названия и стили для структурных элементов отчета
 * (например, "ВВЕДЕНИЕ", "ЗАКЛЮЧЕНИЕ") и обычных разделов,
 * обеспечивая их соответствие ГОСТ 7.32-2017.
 */

/*
 * Словарь с фиксированными названиями структурных элементов отчета.
 *
 * ГОСТ 7.32-2017, раздел 5: "Требования к структурным элементам отчета".
 * ГОСТ 7.32-2017, п. 6.2.1: "Наименования структурных элементов отчета: "СПИСОК ИСПОЛНИТЕЛЕЙ", "РЕФЕРАТ", "СОДЕРЖАНИЕ", "ТЕРМИНЫ И ОПРЕДЕЛЕНИЯ", "ПЕРЕЧЕНЬ СОКРАЩЕНИЙ И ОБОЗНАЧЕНИЙ", "ВВЕДЕНИЕ", "ЗАКЛЮЧЕНИЕ", "СПИСОК ИСПОЛЬЗОВАННЫХ ИСТОЧНИКОВ", "ПРИЛОЖЕНИЕ" служат заголовками структурных элементов отчета."
 */
#let structural-heading-titles = (
  performers: [Список исполнителей],
  abstract: [Реферат],
  contents: [Содержание],
  terms: [Термины и определения],
  abbreviations: [Перечень сокращений и обозначений],
  intro: [Введение],
  conclusion: [Заключение],
  references: [Список использованных источников],
)

/*
 * Стиль для структурных заголовков (например, "ВВЕДЕНИЕ").
 *
 * ГОСТ 7.32-2017, п. 6.2.1: "Заголовки структурных элементов следует располагать в середине строки без точки в конце, прописными буквами, не подчеркивая."
 */
#let structure-heading-style = it => {
  align(center)[#upper(it)]
}

// Функция для создания структурного заголовка.
#let structure-heading(body) = {
  structure-heading-style(heading(numbering: none)[#body])
}

// Основная функция `headings` для настройки всех заголовков в документе.
#let headings(text-size, indent, pagebreaks) = body => {
  /*
   * ГОСТ 7.32-2017, п. 6.2.3: "Заголовки разделов и подразделов основной части отчета следует начинать с абзацного отступа и размещать после порядкового номера, печатать с прописной буквы, полужирным шрифтом, не подчеркивать, без точки в конце."
   * В данном шаблоне размер шрифта заголовков совпадает с основным текстом, что допустимо.
   */
  show heading: set text(size: text-size)

  /*
   * ГОСТ 7.32-2017, п. 6.4.1: "Подразделы должны иметь нумерацию в пределах каждого раздела. Номер подраздела состоит из номеров раздела и подраздела, разделенных точкой."
   */
  set heading(numbering: "1.1")

  // Правило для отображения заголовков.
  show heading: it => {
    if it.body not in structural-heading-titles.values() {
      /*
       * ГОСТ 7.32-2017, п. 6.2.3: "Заголовки разделов и подразделов основной части отчета следует начинать с абзацного отступа..."
       */
      pad(it, left: indent)
    } else {
      it
    }
  }

  // Правило для заголовков первого уровня (разделов).
  show heading.where(level: 1): it => {
    if pagebreaks {
      /*
       * ГОСТ 7.32-2017, п. 6.2.1: "...каждый раздел основной части отчета начинают с новой страницы."
       */
      pagebreak(weak: true)
    }
    it
  }

  // Селектор для всех структурных заголовков.
  let structural-heading = structural-heading-titles.values().fold(selector, (acc, i) => acc.or(heading.where(body: i, level: 1)))

  /*
   * ГОСТ 7.32-2017, п. 6.2.1: "Наименования структурных элементов отчета ... служат заголовками структурных элементов отчета."
   * Структурные заголовки не нумеруются.
   */
  show structural-heading: set heading(numbering: none)
  show structural-heading: it => {
    if pagebreaks {
      /*
       * ГОСТ 7.32-2017, п. 6.2.1: "Каждый структурный элемент ... начинают с новой страницы."
       */
      pagebreak(weak: true)
    }
    structure-heading-style(it)
  }

  /*
   * ГОСТ не регламентирует точные отступы до и после заголовков, но требует их наличия для визуального отделения.
   * В данном шаблоне используются относительные единицы `em` для масштабируемости.
   */
  show heading: set block(below: 2em, above: 2em)

  // Отобразить основное содержимое.
  body
}
